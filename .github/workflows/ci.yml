name: CI/CD

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

permissions:
  contents: read
  packages: write

env:
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend:latest
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend:latest
  DB_HOST: "172.30.1.85"

jobs:
  build-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: maven

      - name: Maven package
        working-directory: backend
        run: mvn -B -DskipTests clean package

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Docker build backend
        run: docker build -t "${{ env.BACKEND_IMAGE }}" -f Dockerfile.backend .

      - name: Docker push backend
        run: docker push "${{ env.BACKEND_IMAGE }}"

  build-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: next-seo/package-lock.json

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Docker build frontend
        run: docker build -t "${{ env.FRONTEND_IMAGE }}" -f Dockerfile.frontend .

      - name: Docker push frontend
        run: docker push "${{ env.FRONTEND_IMAGE }}"

  deploy:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.K3S_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.K3S_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to K3s
        env:
          K3S_HOST: ${{ secrets.K3S_HOST }}
          K3S_USER: ${{ secrets.K3S_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE }}
          FRONTEND_IMAGE: ${{ env.FRONTEND_IMAGE }}
          NAMESPACE: default
        run: |
          # K3s ÏÑúÎ≤ÑÏóê Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ï†ÑÏÜ°
          scp -r k8s ${K3S_USER}@${K3S_HOST}:~/blog-deploy/

          # K3s ÏÑúÎ≤ÑÏóêÏÑú Î∞∞Ìè¨ Ïã§Ìñâ
          ssh ${K3S_USER}@${K3S_HOST} bash << EOF
            set -e
            cd ~/blog-deploy/k8s

            echo "üîê Creating GHCR pull secret..."
            kubectl delete secret ghcr-secret -n ${NAMESPACE} --ignore-not-found
            kubectl create secret docker-registry ghcr-secret -n ${NAMESPACE} \
              --docker-server=ghcr.io \
              --docker-username=${GITHUB_ACTOR} \
              --docker-password=${GITHUB_TOKEN} \
              --docker-email=${GITHUB_ACTOR}@users.noreply.github.com

            echo "üîê Updating DB secrets..."
            kubectl delete secret blog-db-secret -n ${NAMESPACE} --ignore-not-found
            kubectl create secret generic blog-db-secret -n ${NAMESPACE} \
              --from-literal=DB_USER=blog_user \
              --from-literal=DB_PASSWORD="${DB_PASSWORD}"

            echo "üìù Applying ConfigMap..."
            kubectl apply -f database-config.yaml -n ${NAMESPACE}

            echo "üöÄ Deploying backend..."
            kubectl apply -f backend-deployment.yaml -n ${NAMESPACE}
            kubectl set image deployment/blog-backend \
              backend=${BACKEND_IMAGE} -n ${NAMESPACE}

            echo "üöÄ Deploying frontend..."
            kubectl apply -f frontend-deployment.yaml -n ${NAMESPACE}
            kubectl set image deployment/blog-frontend \
              frontend=${FRONTEND_IMAGE} -n ${NAMESPACE}

            echo "‚è≥ Waiting for rollout..."
            kubectl rollout status deployment/blog-backend -n ${NAMESPACE} --timeout=300s
            kubectl rollout status deployment/blog-frontend -n ${NAMESPACE} --timeout=300s

            echo "‚úÖ Deployment completed!"
            kubectl get pods -n ${NAMESPACE}
          EOF

      - name: Deployment Status
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Image: ${{ env.BACKEND_IMAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Image: ${{ env.FRONTEND_IMAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "- K3s Host: ${{ secrets.K3S_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- DB Host: ${{ env.DB_HOST }}" >> $GITHUB_STEP_SUMMARY
