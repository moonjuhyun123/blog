name: CI/CD

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend:latest
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend:latest
  NAMESPACE: default

jobs:
  # GitHub 클라우드에서 빌드
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: maven
      
      - name: Maven Build
        working-directory: backend
        run: mvn -B -DskipTests clean package
      
      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      
      - name: Build and Push Backend
        run: |
          docker build -f Dockerfile.backend -t ${{ env.BACKEND_IMAGE }} .
          docker push ${{ env.BACKEND_IMAGE }}
      
      - name: Build and Push Frontend
        run: |
          docker build -f Dockerfile.frontend \
            --build-arg NEXT_PUBLIC_API_URL="" \
            -t ${{ env.FRONTEND_IMAGE }} .
          docker push ${{ env.FRONTEND_IMAGE }}

  # Self-hosted runner에서 배포 (이미지 pull + kubectl)
  deploy:
    needs: build
    runs-on: self-hosted
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # kubeconfig 권한 오류 시: CICD-QUICKSTART.md "kubeconfig: permission denied" 참고
      - name: Verify kubectl access
        run: |
          kubectl cluster-info || (echo "::error::kubectl 접근 실패. K3s 서버에서 Runner 사용자에게 kubeconfig 권한을 설정하세요. CICD-QUICKSTART.md 트러블슈팅 참고." && exit 1)
      
      # GHCR_PAT 없으면 비밀번호가 비어 있어 create secret 실패. 저장소 Secrets에 GHCR_PAT 추가 필요
      - name: Create GHCR Pull Secret
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        run: |
          if [ -z "$GHCR_PAT" ]; then
            echo "::error::GHCR_PAT Secret이 없습니다. 저장소 Settings → Secrets and variables → Actions 에서 GHCR_PAT(PAT, read:packages) 추가 후 재실행하세요."
            exit 1
          fi
          kubectl delete secret ghcr-secret -n ${{ env.NAMESPACE }} --ignore-not-found
          kubectl create secret docker-registry ghcr-secret -n ${{ env.NAMESPACE }} \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password="$GHCR_PAT" \
            --docker-email=${{ github.actor }}@users.noreply.github.com
      
      # ConfigMap 먼저 적용 (DB_HOST 등). 그 다음 Secret 적용해야 Secret이 덮어쓰이지 않음
      - name: Apply ConfigMap
        run: kubectl apply -f k8s/database-config.yaml -n ${{ env.NAMESPACE }}
      
      - name: Update DB Secret
        run: |
          kubectl delete secret blog-db-secret -n ${{ env.NAMESPACE }} --ignore-not-found
          kubectl create secret generic blog-db-secret -n ${{ env.NAMESPACE }} \
            --from-literal=DB_USER=csr \
            --from-literal=DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
      
      - name: Deploy Backend
        run: |
          kubectl apply -f k8s/backend-deployment.yaml -n ${{ env.NAMESPACE }}
          kubectl set image deployment/blog-backend \
            backend=${{ env.BACKEND_IMAGE }} -n ${{ env.NAMESPACE }}
      
      - name: Deploy Frontend
        run: |
          kubectl apply -f k8s/frontend-deployment.yaml -n ${{ env.NAMESPACE }}
          kubectl set image deployment/blog-frontend \
            frontend=${{ env.FRONTEND_IMAGE }} -n ${{ env.NAMESPACE }}
      
      - name: Wait for Rollout
        id: rollout
        run: |
          kubectl rollout status deployment/blog-backend -n ${{ env.NAMESPACE }} --timeout=900s
          kubectl rollout status deployment/blog-frontend -n ${{ env.NAMESPACE }} --timeout=300s
      
      # Rollout 실패 시 Pod 이벤트·로그를 Actions에 출력 (서버 접속 없이 원인 확인)
      - name: Dump pod logs on Rollout failure
        if: failure() && steps.rollout.outcome == 'failure'
        run: |
          echo "=== Pods (상태) ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide
          echo ""
          echo "=== Backend Pod Events ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=blog-backend -o name | head -1 | xargs -r kubectl describe -n ${{ env.NAMESPACE }} | tail -30
          echo ""
          echo "=== Backend Pod Logs (최근 150줄) ==="
          kubectl logs deployment/blog-backend -n ${{ env.NAMESPACE }} --tail=150 --all-containers=true 2>/dev/null || true
          echo ""
          echo "=== Backend Pod Logs (재시작 직전) ==="
          kubectl logs deployment/blog-backend -n ${{ env.NAMESPACE }} --previous --tail=100 --all-containers=true 2>/dev/null || true
          echo ""
          echo "=== Frontend Pod Events ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=blog-frontend -o name | head -1 | xargs -r kubectl describe -n ${{ env.NAMESPACE }} | tail -30
          echo ""
          echo "=== Frontend Pod Logs (최근 100줄) ==="
          kubectl logs deployment/blog-frontend -n ${{ env.NAMESPACE }} --tail=100 --all-containers=true 2>/dev/null || true
      
      - name: Show Status
        if: always()
        run: |
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo "=== Services ==="
          kubectl get svc -n ${{ env.NAMESPACE }}
